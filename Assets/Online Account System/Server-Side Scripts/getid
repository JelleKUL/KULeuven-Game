<?php

// CHECKLOGIN.PHP
// INPUT: (username, password) via _POST
// FUNCTIONALITY: Tries to login with the provided username and password. 
// NOTES: If a "isactive" column is found for the requested account we check if it's set to true
// OUTPUT: "-2" if there was no match, "-1" if the account is inactive - otherwise returns the user's ID

// And some helper functions
require('helper.php'); 

// Load the credentials that have been set-up by Online Account System in Unity's editor
require('credentials.php');

// Connect to server and select databse.
$link = try_mysql_connect($databaseHostname, $databaseUsername, $databasePassword, $databaseDbName, $databasePort);

mysqli_set_charset($link, 'utf8');

// Preferences sent from form
$requireEmailActivation=$_POST['requireEmailActivation'];

// username and password sent from form
$username=$_POST['username'];


// To protect MySQL injection (more detail about MySQL injection)
$username = stripslashes($username);
$username = mysqli_real_escape_string($link, $username);

$query="SELECT * FROM accounts WHERE username= '$username' and shibboleth = 1";
$result=try_mysql_query($link, $query);

// Mysql_num_row is counting table row
$count=mysqli_num_rows($result);

// If result matched $username and $password, table row must be 1 row
if($count==0){
	
	
}
// If we didn't match
else {
    //die ("-2");
    $fieldNames = "username";
    $fieldValues = $username;

    $fieldNames = "password";
    $fieldValues = "";

    $fieldNames = "strudentnr";
    $fieldValues = $username;

    $fieldNames .= "creationdate";
    $fieldValues .=  'CURRENT_TIMESTAMP';//date("Y-m-d H:i:s");
    
    $fieldNames .= "creationdate";
    $fieldValues .=  'CURRENT_TIMESTAMP';//date("Y-m-d H:i:s");
    

    $fieldNames .= "shibboleth";
    $fieldValues .=  1;

    $fieldNames = rtrim( $fieldNames, ",");
    $fieldValues = rtrim( $fieldValues, ",");

    $query = "INSERT INTO accounts 
    (" . $fieldNames .")
    VALUES ( " . $fieldValues . " )";

    try_mysql_query($link, $query);

    $query="SELECT * FROM accounts WHERE username= '$username' and shibboleth = 1";
    $result=try_mysql_query($link, $query);
    $temp = mysqli_fetch_array($result);  
       
    echo $temp['id'];  
    exit();
}

?>